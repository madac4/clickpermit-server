version: '3.8'

services:
    # MongoDB Database
    mongodb:
        image: mongo:7
        container_name: dispatcher-mongodb
        restart: unless-stopped
        environment:
            MONGO_INITDB_ROOT_USERNAME: admin
            MONGO_INITDB_ROOT_PASSWORD: password123
        ports:
            - '27017:27017'
        volumes:
            - mongodb_data:/data/db
        networks:
            - dispatcher-network

    # Node.js Backend API
    api:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: dispatcher-api
        restart: unless-stopped
        environment:
            NODE_ENV: production
            PORT: 5000
            MONGODB_URI: mongodb://admin:password123@mongodb:27017/dispatcher?authSource=admin
            JWT_SECRET: your-jwt-secret-key-change-in-production
            REFRESH_TOKEN_SECRET: your-refresh-token-secret-change-in-production
            FRONTEND_ORIGIN: http://localhost:3000
            # Chrome/Chromium is already configured in the Dockerfile
            CHROME_BIN: /usr/bin/chromium-browser
        ports:
            - '5000:5000'
        depends_on:
            - mongodb
        volumes:
            # Mount .env file if it exists
            - ./.env:/app/.env:ro
            # Persist uploaded files (optional)
            - uploads:/app/uploads
        networks:
            - dispatcher-network
        command: node dist/server.js

volumes:
    mongodb_data:
        driver: local
    uploads:
        driver: local

networks:
    dispatcher-network:
        driver: bridge
